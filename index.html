<!DOCTYPE html>
<html lang="en">

<script>

  if (sessionStorage.getItem("messageString") === null) {
      sessionStorage.setItem("messageString", "");
  }

  if (!!window.EventSource) {
    console.log('start script' );
    let source = new EventSource('/events')

    source.onmessage = function(event) {
        let vf = document.getElementById('displaytext');
        let data = event.data.toUpperCase();
        if (data !== " " ) {
        console.log('onmessage  got >' + data + '<'  ) ;
        if (data === "AA") { data = "\n" };
        data = data.replaceAll(" AA ", "\n" );
        let messageString = sessionStorage.getItem("messageString") + " " +  data;
        sessionStorage.setItem("messageString", messageString);
        vf.value = messageString;
        }
    }

  } else {
    console.log("Your browser doesn't support SSE")
  }
</script>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preload" href="fonts/TelegHPLHS.otf" as="font" type="font/otf" crossorigin>
    <link rel="stylesheet"  href="style.css" >
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="refresh" content="300">
    <title>Telegraph Office</title>
</head>

<body>
   <div class="head"> 
     <img src="header.png"  text-align="center">
   </div>

    <form id="messageform" >
        <label for="name" style="font-family: Telegram HPLHS" >Telegraph Message</label>
        <textarea rows = "10" id="displaytext" name="textvalue" readonly ></textarea>
    </form>

    <form class="container" id="clearform" action="/submit-clear" method="POST">
        <button type="submit">Clear Telegram</button>
    </form>

    <!-- The form sends a POST request to the /submit-form route -->
    <form class="container" id="selectform" action="/submit-form" method="POST">
         <label for="destination">Choose destinations (hold Ctrl/Cmd to select multiple):</label>
         <select class="select" name="destination" id="destination" size=3 multiple>
         </select>

        <label for="textField" style="font-family: Telegram HPLHS"><br>Enter Text:</label>
        <input type="text" id="textField" name="textField" required>
        <button type="submit">Send Message</button>
    </form>

</body>  
</html>


<script>
  const selbox = document.getElementById("destination");
  const storedSelections = JSON.parse(localStorage.getItem('multiSelectSelections')) || [];

  fetch('./entries.json')
              .then( response => response.json() )
              .then( entries  => { 
             
               for (i = 0; i < entries.length; i++) {
                    item = entries[i];
                    const option = document.createElement("OPTION");
                    option.innerHTML = item.label;
                    option.value = item.address;
                    
                    storedSelections.forEach(value => {
                       if (value == option.value) {
                          option.selected = true;
                       }
                    });
                    selbox.appendChild(option);
               };
             }

             
   );

    // Save selections on change event
    selbox.addEventListener('change', () => {
        const selectedValues = Array.from(selbox.selectedOptions).map(option => option.value);
        localStorage.setItem('multiSelectSelections', JSON.stringify(selectedValues));
    });

</script>
